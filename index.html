<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DTMC Teacher Solver</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <style>
        .input-cell { width: 60px; text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; padding: 2px; }
        .cost-cell { width: 60px; text-align: center; border: 1px solid #fed7aa; border-radius: 4px; padding: 2px; background-color: #fff7ed; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 md:p-8">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { ScatterChart, Scatter, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceArea, Cell } = Recharts;

        const TeacherSolver = () => {
            // Initial State setup
            const [matrix, setMatrix] = useState([
                [0.7, 0.2, 0.1],
                [0.3, 0.5, 0.2],
                [0.2, 0.3, 0.5]
            ]);
            const [costs, setCosts] = useState([
                [10, 10, 10],
                [10, 10, 10],
                [10, 10, 10]
            ]);
            const [budget, setBudget] = useState(100);
            const [results, setResults] = useState([]);
            const [isSimulating, setIsSimulating] = useState(false);

            // Math: Solve Steady State via Power Method
            const getSteadyState = (m) => {
                let s = [0.33, 0.33, 0.34];
                for (let i = 0; i < 50; i++) {
                    let next = [0, 0, 0];
                    for (let col = 0; col < 3; col++) {
                        for (let row = 0; row < 3; row++) {
                            next[col] += s[row] * m[row][col];
                        }
                    }
                    s = next;
                }
                return s;
            };

            const handleMatrixChange = (r, c, val) => {
                const newM = [...matrix.map(row => [...row])];
                newM[r][c] = parseFloat(val) || 0;
                setMatrix(newM);
            };

            const handleCostChange = (r, c, val) => {
                const newC = [...costs.map(row => [...row])];
                newC[r][c] = parseFloat(val) || 0;
                setCosts(newC);
            };

            const runSimulation = () => {
                setIsSimulating(true);
                const cloud = [];
                const samples = 2000;

                for (let i = 0; i < samples; i++) {
                    let tempMatrix = matrix.map(row => [...row]);
                    let spent = 0;

                    // For each row, attempt a random valid swap of probability
                    for (let r = 0; r < 3; r++) {
                        // Pick two random cells in the row to swap between
                        const c1 = Math.floor(Math.random() * 3);
                        const c2 = Math.floor(Math.random() * 3);
                        if (c1 === c2) continue;

                        // Max change is 0.3 to keep it somewhat realistic
                        const delta = (Math.random() * 0.4) - 0.2; 
                        const cost = Math.abs(delta) * 100 * (costs[r][c1] + costs[r][c2]);

                        if (spent + cost <= budget && 
                            tempMatrix[r][c1] + delta >= 0 && tempMatrix[r][c1] + delta <= 1 &&
                            tempMatrix[r][c2] - delta >= 0 && tempMatrix[r][c2] - delta <= 1) {
                            
                            tempMatrix[r][c1] += delta;
                            tempMatrix[r][c2] -= delta;
                            spent += cost;
                        }
                    }

                    const ss = getSteadyState(tempMatrix);
                    cloud.push({ x: ss[0], y: ss[2], inTarget: (ss[0] >= 0.7 && ss[2] <= 0.1) });
                }
                setResults(cloud);
                setIsSimulating(false);
            };

            const currentSS = getSteadyState(matrix);

            return (
                <div className="max-w-5xl mx-auto space-y-6">
                    <header className="bg-indigo-700 text-white p-6 rounded-xl shadow-lg">
                        <h1 className="text-2xl font-bold">Assignment Calibration Tool</h1>
                        <p className="opacity-80">Test if your budget and costs make the target achievable.</p>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* LEFT: Configuration */}
                        <div className="space-y-6">
                            <div className="bg-white p-6 rounded-xl shadow-sm border">
                                <h2 className="font-bold text-lg mb-4 text-slate-700 underline decoration-indigo-500">1. Original Matrix & Costs</h2>
                                <div className="space-y-4">
                                    {matrix.map((row, r) => (
                                        <div key={r} className="flex items-center space-x-4">
                                            <span className="w-20 text-sm font-medium">State {r+1}</span>
                                            {row.map((val, c) => (
                                                <div key={c} className="flex flex-col items-center">
                                                    <input 
                                                        type="number" step="0.01" value={val} 
                                                        onChange={(e) => handleMatrixChange(r, c, e.target.value)}
                                                        className="input-cell"
                                                    />
                                                    <input 
                                                        type="number" value={costs[r][c]} 
                                                        onChange={(e) => handleCostChange(r, c, e.target.value)}
                                                        className="cost-cell mt-1 text-xs"
                                                    />
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                    <p className="text-xs text-slate-400 italic mt-2">White: Initial Prob | Orange: Cost per 0.01 change</p>
                                </div>
                            </div>

                            <div className="bg-white p-6 rounded-xl shadow-sm border">
                                <h2 className="font-bold text-lg mb-4 text-slate-700 underline decoration-indigo-500">2. Global Settings</h2>
                                <div className="flex items-center space-x-4">
                                    <label className="text-sm font-medium">Budget $:</label>
                                    <input 
                                        type="number" value={budget} 
                                        onChange={(e) => setBudget(parseFloat(e.target.value) || 0)}
                                        className="border rounded px-2 py-1 w-24"
                                    />
                                    <button 
                                        onClick={runSimulation}
                                        disabled={isSimulating}
                                        className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold transition flex-1"
                                    >
                                        {isSimulating ? 'Processing...' : 'Simulate All Possible Changes'}
                                    </button>
                                </div>
                            </div>

                            <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                                <h3 className="font-bold text-indigo-900 text-sm">Target Requirements:</h3>
                                <ul className="text-sm text-indigo-700 list-disc ml-5 mt-1">
                                    <li>State 1 (X-axis) ≥ 0.70</li>
                                    <li>State 3 (Y-axis) ≤ 0.10</li>
                                </ul>
                            </div>
                        </div>

                        {/* RIGHT: Visualization */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border min-h-[400px]">
                            <h2 className="font-bold text-lg mb-2 text-slate-700">Feasibility Map</h2>
                            <p className="text-xs text-slate-500 mb-4">Each dot is a different way the student could spend their budget. Dots in the <b>green box</b> mean the target is reachable.</p>
                            
                            <div className="h-80 w-full">
                                <ResponsiveContainer>
                                    <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 20 }}>
                                        <CartesianGrid strokeDasharray="3 3" />
                                        <XAxis type="number" dataKey="x" name="State 1" domain={[0, 1]} label={{ value: 'State 1', position: 'bottom' }} />
                                        <YAxis type="number" dataKey="y" name="State 3" domain={[0, 1]} label={{ value: 'State 3', angle: -90, position: 'left' }} />
                                        <Tooltip cursor={{ strokeDasharray: '3 3' }} />
                                        
                                        {/* Target Area Box */}
                                        <ReferenceArea x1={0.7} x2={1.0} y1={0} y2={0.1} fill="#dcfce7" fillOpacity={0.5} stroke="#22c55e" strokeDasharray="3 3" />
                                        
                                        <Scatter name="Possible Outcomes" data={results}>
                                            {results.map((entry, index) => (
                                                <Cell key={`cell-${index}`} fill={entry.inTarget ? '#22c55e' : '#6366f1'} opacity={0.4} />
                                            ))}
                                        </Scatter>
                                    </ScatterChart>
                                </ResponsiveContainer>
                            </div>
                            
                            <div className="mt-6 p-4 rounded bg-slate-50 border grid grid-cols-2 gap-4">
                                <div>
                                    <p className="text-xs font-bold text-slate-500 uppercase">Current Steady State</p>
                                    <p className="text-sm font-mono">[{currentSS[0].toFixed(2)}, {currentSS[1].toFixed(2)}, {currentSS[2].toFixed(2)}]</p>
                                </div>
                                <div>
                                    <p className="text-xs font-bold text-slate-500 uppercase">Feasibility</p>
                                    <p className={`text-sm font-bold ${results.some(r => r.inTarget) ? 'text-green-600' : 'text-red-500'}`}>
                                        {results.length === 0 ? "Run simulation..." : results.some(r => r.inTarget) ? "SOLVABLE" : "IMPOSSIBLE"}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TeacherSolver />);
    </script>
</body>
</html>